{% extends "base.html" %}

{% block title %}Settings - Observability Dashboard{% endblock %}

{% block page_title %}Settings{% endblock %}

{% block head_extra %}
<!-- Additional CSS for settings page -->
<style>
    .settings-container {
        max-width: 1000px;
        margin: 0 auto;
    }
    
    .tabs {
        display: flex;
        gap: 5px;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
    }
    
    .tab {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 2px solid transparent;
    }
    
    .tab.active {
        border-bottom-color: var(--accent-color);
        color: var(--accent-color);
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .settings-card {
        margin-bottom: 20px;
    }
    
    .theme-selector {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: 15px;
    }
    
    .theme-option {
        width: 120px;
        height: 80px;
        border-radius: 4px;
        cursor: pointer;
        overflow: hidden;
        position: relative;
        border: 2px solid transparent;
        transition: transform 0.2s ease, border-color 0.2s ease;
    }
    
    .theme-option:hover {
        transform: translateY(-5px);
    }
    
    .theme-option.active {
        border-color: var(--accent-color);
    }
    
    .theme-preview {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    .theme-preview-header {
        height: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .theme-preview-content {
        display: flex;
        flex: 1;
    }
    
    .theme-preview-sidebar {
        width: 30px;
        height: 100%;
        border-right: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .theme-preview-main {
        flex: 1;
        padding: 5px;
    }
    
    .theme-preview-card {
        width: 100%;
        height: 20px;
        border-radius: 2px;
        margin-bottom: 3px;
    }
    
    .theme-name {
        text-align: center;
        margin-top: 5px;
        font-size: 0.9rem;
    }
    
    .dark-theme .theme-preview {
        background-color: #121212;
    }
    
    .dark-theme .theme-preview-header,
    .dark-theme .theme-preview-sidebar {
        background-color: #1e1e1e;
    }
    
    .dark-theme .theme-preview-card {
        background-color: #2d2d2d;
    }
    
    .light-theme .theme-preview {
        background-color: #f5f5f5;
    }
    
    .light-theme .theme-preview-header,
    .light-theme .theme-preview-sidebar {
        background-color: #ffffff;
    }
    
    .light-theme .theme-preview-card {
        background-color: #e9ecef;
    }
    
    .blue-theme .theme-preview {
        background-color: #1a2a42;
    }
    
    .blue-theme .theme-preview-header,
    .blue-theme .theme-preview-sidebar {
        background-color: #2c3e50;
    }
    
    .blue-theme .theme-preview-card {
        background-color: #34495e;
    }
    
    .green-theme .theme-preview {
        background-color: #1e382a;
    }
    
    .green-theme .theme-preview-header,
    .green-theme .theme-preview-sidebar {
        background-color: #2d5941;
    }
    
    .green-theme .theme-preview-card {
        background-color: #3a7655;
    }
    
    .api-token {
        font-family: monospace;
        background-color: var(--secondary-bg);
        padding: 10px;
        border-radius: 4px;
        position: relative;
    }
    
    .copy-token {
        position: absolute;
        top: 5px;
        right: 5px;
        background: none;
        border: none;
        color: var(--accent-color);
        cursor: pointer;
    }
    
    .connections-list {
        margin-top: 20px;
    }
    
    .connection-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background-color: var(--secondary-bg);
        border-radius: 4px;
        margin-bottom: 10px;
    }
    
    .connection-info {
        display: flex;
        flex-direction: column;
    }
    
    .connection-name {
        font-weight: 500;
        margin-bottom: 5px;
    }
    
    .connection-meta {
        font-size: 0.85rem;
        color: var(--secondary-text);
    }
    
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 40px;
        height: 20px;
    }
    
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--border-color);
        transition: .4s;
        border-radius: 20px;
    }
    
    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 2px;
        bottom: 2px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
        background-color: var(--accent-color);
    }
    
    input:checked + .toggle-slider:before {
        transform: translateX(20px);
    }
    
    .form-section {
        margin-bottom: 30px;
    }
    
    .avatar-upload {
        width: 150px;
        height: 150px;
        position: relative;
        margin: 0 auto 20px;
    }
    
    .avatar-preview {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        overflow: hidden;
        background-color: var(--secondary-bg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        color: var(--accent-color);
    }
    
    .avatar-edit {
        position: absolute;
        right: 0;
        bottom: 0;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: var(--accent-color);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
    
    .password-strength {
        margin-top: 10px;
        height: 5px;
        background-color: var(--border-color);
        border-radius: 5px;
        overflow: hidden;
    }
    
    .password-strength-bar {
        height: 100%;
        width: 0;
        transition: width 0.3s ease;
    }
    
    .strength-weak .password-strength-bar {
        width: 33%;
        background-color: var(--error-color);
    }
    
    .strength-medium .password-strength-bar {
        width: 66%;
        background-color: var(--warning-color);
    }
    
    .strength-strong .password-strength-bar {
        width: 100%;
        background-color: var(--success-color);
    }
    
    .strength-text {
        font-size: 0.8rem;
        margin-top: 5px;
    }
    
    .data-retention-slider {
        width: 100%;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="settings-container">
    <!-- Tabs -->
    <div class="tabs">
        <div class="tab active" data-tab="profile">Profile</div>
        <div class="tab" data-tab="appearance">Appearance</div>
        <div class="tab" data-tab="integrations">Integrations</div>
        <div class="tab" data-tab="notifications">Notifications</div>
        <div class="tab" data-tab="security">Security</div>
        <div class="tab" data-tab="data">Data Management</div>
        <div class="tab" data-tab="api">API Access</div>
    </div>
    
    <!-- Profile Tab -->
    <div id="profile-tab" class="tab-content active">
        <div class="card settings-card">
            <div class="card-header">
                <h3 class="card-title">Profile Information</h3>
            </div>
            <div class="card-body">
                <form id="profile-form">
                    <div class="avatar-upload">
                        <div class="avatar-preview">
                            {% if current_user.avatar %}
                            <img src="{{ current_user.avatar }}" alt="Profile avatar">
                            {% else %}
                            {{ current_user.username[0].upper() }}
                            {% endif %}
                        </div>
                        <div class="avatar-edit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            <input type="file" id="avatar-upload" style="display: none;">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" id="username" class="form-control" value="{{ current_user.username }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" id="email" class="form-control" value="{{ current_user.email }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="full-name" class="form-label">Full Name</label>
                        <input type="text" id="full-name" class="form-control" value="{{ current_user.full_name if current_user.full_name else '' }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="job-title" class="form-label">Job Title</label>
                        <input type="text" id="job-title" class="form-control" value="{{ current_user.job_title if current_user.job_title else '' }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="timezone" class="form-label">Timezone</label>
                        <select id="timezone" class="form-control">
                            <option value="UTC" {% if current_user.timezone == 'UTC' %}selected{% endif %}>UTC</option>
                            <option value="America/New_York" {% if current_user.timezone == 'America/New_York' %}selected{% endif %}>Eastern Time (ET)</option>
                            <option value="America/Chicago" {% if current_user.timezone == 'America/Chicago' %}selected{% endif %}>Central Time (CT)</option>
                            <option value="America/Denver" {% if current_user.timezone == 'America/Denver' %}selected{% endif %}>Mountain Time (MT)</option>
                            <option value="America/Los_Angeles" {% if current_user.timezone == 'America/Los_Angeles' %}selected{% endif %}>Pacific Time (PT)</option>
                            <option value="Europe/London" {% if current_user.timezone == 'Europe/London' %}selected{% endif %}>London (GMT)</option>
                            <option value="Europe/Paris" {% if current_user.timezone == 'Europe/Paris' %}selected{% endif %}>Paris (CET)</option>
                            <option value="Asia/Tokyo" {% if current_user.timezone == 'Asia/Tokyo' %}selected{% endif %}>Tokyo (JST)</option>
                            <option value="Australia/Sydney" {% if current_user.timezone == 'Australia/Sydney' %}selected{% endif %}>Sydney (AEST)</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Appearance Tab -->
    <div id="appearance-tab" class="tab-content">
        <div class="card settings-card">
            <div class="card-header">
                <h3 class="card-title">Theme Settings</h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label">Select Theme</label>
                    <div class="theme-selector">
                        <div class="theme-option dark-theme {{ 'active' if current_user.theme == 'dark' }}" data-theme="dark">
                            <div class="theme-preview">
                                <div class="theme-preview-header"></div>
                                <div class="theme-preview-content">
                                    <div class="theme-preview-sidebar"></div>
                                    <div class="theme-preview-main">
                                        <div class="theme-preview-card"></div>
                                        <div class="theme-preview-card"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="theme-name">Dark</div>
                        </div>
                        
                        <div class="theme-option light-theme {{ 'active' if current_user.theme == 'light' }}" data-theme="light">
                            <div class="theme-preview">
                                <div class="theme-preview-header"></div>
                                <div class="theme-preview-content">
                                    <div class="theme-preview-sidebar"></div>
                                    <div class="theme-preview-main">
                                        <div class="theme-preview-card"></div>
                                        <div class="theme-preview-card"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="theme-name">Light</div>
                        </div>
                        
                        <div class="theme-option blue-theme {{ 'active' if current_user.theme == 'blue' }}" data-theme="blue">
                            <div class="theme-preview">
                                <div class="theme-preview-header"></div>
                                <div class="theme-preview-content">
                                    <div class="theme-preview-sidebar"></div>
                                    <div class="theme-preview-main">
                                        <div class="theme-preview-card"></div>
                                        <div class="theme-preview-card"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="theme-name">Blue</div>
                        </div>
                        
                        <div class="theme-option green-theme {{ 'active' if current_user.theme == 'green' }}" data-theme="green">
                            <div class="theme-preview">
                                <div class="theme-preview-header"></div>
                                <div class="theme-preview-content">
                                    <div class="theme-preview-sidebar"></div>
                                    <div class="theme-preview-main">
                                        <div class="theme-preview-card"></div>
                                        <div class="theme-preview-card"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="theme-name">Green</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group mt-4">
                    <label class="form-label d-block">Theme Mode</label>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="theme-mode" id="dark-mode" value="dark" {{ 'checked' if current_user.theme.startswith('dark') }}>
                        <label class="form-check-label" for="dark-mode">Dark Mode</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="theme-mode" id="light-mode" value="light" {{ 'checked' if current_user.theme.startswith('light') }}>
                        <label class="form-check-label" for="light-mode">Light Mode</label>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card settings-card">
            <div class="card-header">
                <h3 class="card-title">Dashboard Layout</h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="default-dashboard" class="form-label">Default Dashboard</label>
                    <select id="default-dashboard" class="form-control">
                        <option value="">-- Select Default Dashboard --</option>
                        {% for dashboard in dashboards %}
                        <option value="{{ dashboard.id }}" {% if dashboard.id == default_dashboard_id %}selected{% endif %}>{{ dashboard.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Sidebar Display</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="sidebar-collapsed" {{ 'checked' if current_user.preferences.sidebar_collapsed }}>
                        <label class="form-check-label" for="sidebar-collapsed">Start with sidebar collapsed</label>
                    </div>
                </div>
                
                <button id="save-appearance" class="btn btn-primary">Save Appearance Settings</button>
            </div>
        </div>
    </div>
    
    <!-- Integrations Tab -->
    <div id="integrations-tab" class="tab-content">
        <div class="card settings-card">
            <div class="card-header">
                <h3 class="card-title">Connected Services</h3>
            </div>
            <div class="card-body">
                <p class="text-muted">Manage your connected third-party services and integrations.</p>
                
                <div class="connections-list">
                    <!-- Slack Integration -->
                    <div class="connection-item">
                        <div class="connection-info">
                            <div class="connection-name">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M14.5 10c-.83 0-1.5-.67-1.5-1.5v-5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5v5c0 .83-.67 1.5-1.5 1.5z"></path>
                                    <path d="M20.5 10H19V8.5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"></path>
                                    <path d="M9.5 14c.83 0 1.5.67 1.5 1.5v5c0 .83-.67 1.5-1.5 1.5S8 21.33 8 20.5v-5c0-.83.67-1.5 1.5-1.5z"></path>
                                    <path d="M3.5 14H5v1.5c0 .83-.67 1.5-1.5 1.5S2 16.33 2 15.5 2.67 14 3.5 14z"></path>
                                    <path d="M14 14.5c0-.83.67-1.5 1.5-1.5h5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5h-5c-.83 0-1.5-.67-1.5-1.5z"></path>
                                    <path d="M15.5 19H14v1.5c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5-.67-1.5-1.5-1.5z"></path>
                                    <path d="M10 9.5C10 8.67 9.33 8 8.5 8h-5C2.67 8 2 8.67 2 9.5S2.67 11 3.5 11h5c.83 0 1.5-.67 1.5-1.5z"></path>
                                    <path d="M8.5 5H10V3.5C10 2.67 9.33 2 8.5 2S7 2.67 7 3.5 7.67 5 8.5 5z"></path>
                                </svg>
                                Slack
                            </div>
                            <div class="connection-meta">
                                {% if integrations.slack %}
                                Connected to workspace: {{ integrations.slack.workspace }}
                                {% else %}
                                Not connected
                                {% endif %}
                            </div>
                        </div>
                        <div class="connection-actions">
                            {% if integrations.slack %}
                            <button class="btn btn-danger disconnect-integration" data-service="slack">Disconnect</button>
                            {% else %}
                            <button class="btn btn-primary connect-integration" data-service="slack">Connect</button>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- PagerDuty Integration -->
                    <div class="connection-item">
                        <div class="connection-info">
                            <div class="connection-name">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M22 17H2a3 3 0 0 0 3-3V9a7 7 0 0 1 14 0v5a3 3 0 0 0 3 3zm-8.27 4a2 2 0 0 1-3.46 0"></path>
                                </svg>
                                PagerDuty
                            </div>
                            <div class="connection-meta">
                                {% if integrations.pagerduty %}
                                Connected to account: {{ integrations.pagerduty.account }}
                                {% else %}
                                Not connected
                                {% endif %}
                            </div>
                        </div>
                        <div class="connection-actions">
                            {% if integrations.pagerduty %}
                            <button class="btn btn-danger disconnect-integration" data-service="pagerduty">Disconnect</button>
                            {% else %}
                            <button class="btn btn-primary connect-integration" data-service="pagerduty">Connect</button>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Microsoft Teams Integration -->
                    <div class="connection-item">
                        <div class="connection-info">
                            <div class="connection-name">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                </svg>
                                Microsoft Teams
                            </div>
                            <div class="connection-meta">
                                {% if integrations.teams %}
                                Connected to team: {{ integrations.teams.team }}
                                {% else %}
                                Not connected
                                {% endif %}
                            </div>
                        </div>
                        <div class="connection-actions">
                            {% if integrations.teams %}
                            <button class="btn btn-danger disconnect-integration" data-service="teams">Disconnect</button>
                            {% else %}
                            <button class="btn btn-primary connect-integration" data-service="teams">Connect</button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card settings-card">
            <div class="card-header">
                <h3 class="card-title">Data Collectors</h3>
            </div>
            <div class="card-body">
                <p class="text-muted">Configure the data collectors for ingesting monitoring data.</p>
                
                <div class="connections-list">
                    <!-- Syslog Collector -->
                    <div class="connection-item">
                        <div class="connection-info">
                            <div class="connection-name">Syslog Collector</div>
                            <div class="connection-meta">
                                Port: {{ collector_settings.syslog.port }}
                            </div>
                        </div>
                        <div class="connection-actions">
                            <div class="toggle-switch">
                                <input type="checkbox" id="syslog-enabled" class="collector-toggle" data-collector="syslog" {{ 'checked' if collector_settings.syslog.enabled }}>
                                <label for="syslog-enabled"></label>
                            </div>
                            <button class="btn btn-secondary configure-collector" data-collector="syslog">Configure</button>
                        </div>
                    </div>
                    
                    <!-- SNMP Collector -->
                    <div class="connection-item">
                        <div class="connection-info">
                            <div class="connection-name">SNMP Collector</div>
                            <div class="connection-meta">
                                Port: {{ collector_settings.snmp.port }}
                            </div>
                        </div>
                        <div class="connection-actions">
                            <div class="toggle-switch">
                                <input type="checkbox" id="snmp-enabled" class="collector-toggle" data-collector="snmp" {{ 'checked' if collector_settings.snmp.enabled }}>
                                <label for="snmp-enabled"></label>
                            </div>
                            <button class="btn btn-secondary configure-collector" data-collector="snmp">Configure</button>
                        </div>
                    </div>
                    
                    <!-- NetFlow Collector -->
                    <div class="connection-item">
                        <div class="connection-info">
                            <div class="connection-name">NetFlow Collector</div>
                            <div class="connection-meta">
                                Port: {{ collector_settings.netflow.port }}
                            </div>
                        </div>
                        <div class="connection-actions">
                            <div class="toggle-switch">
                                <input type="checkbox" id="netflow-enabled" class="collector-toggle" data-collector="netflow" {{ 'checked' if collector_settings.netflow.enabled }}>
                                <label for="netflow-enabled"></label>
                            </div>
                            <button class="btn btn-secondary configure-collector" data-collector="netflow">Configure</button>
                        </div>
                    </div>
                    
                    <!-- sFlow Collector -->
                    <div class="connection-item">
                        <div class="connection-info">
                            <div class="connection-name">sFlow Collector</div>
                            <div class="connection-meta">
                                Port: {{ collector_settings.sflow.port }}
                            </div>
                        </div>
                        <div class="connection-actions">
                            <div class="toggle-switch">
                                <input type="checkbox" id="sflow-enabled" class="collector-toggle" data-collector="sflow" {{ 'checked' if collector_settings.sflow.enabled }}>
                                <label for="sflow-enabled"></label>
                            </div>
                            <button class="btn btn-secondary configure-collector" data-collector="sflow">Configure</button>
                        </div>
                    </div>
                    
                    <!-- Windows Events Collector -->
                    <div class="connection-item">
                        <div class="connection-info">
                            <div class="connection-name">Windows Events Collector</div>
                            <div class="connection-meta">
                                Port: {{ collector_settings.windows_events.port }}
                            </div>
                        </div>
                        <div class="connection-actions">
                            <div class="toggle-switch">
                                <input type="checkbox" id="windows-events-enabled" class="collector-toggle" data-collector="windows_events" {{ 'checked' if collector_settings.windows_events.enabled }}>
                                <label for="windows-events-enabled"></label>
                            </div>
                            <button class="btn btn-secondary configure-collector" data-collector="windows_events">Configure</button>
                        </div>
                    </div>
                    
                    <!-- OTEL Collector -->
                    <div class="connection-item">
                        <div class="connection-info">
                            <div class="connection-name">OTEL Collector</div>
                            <div class="connection-meta">
                                Port: {{ collector_settings.otel.port }}
                            </div>
                        </div>
                        <div class="connection-actions">
                            <div class="toggle-switch">
                                <input type="checkbox" id="otel-enabled" class="collector-toggle" data-collector="otel" {{ 'checked' if collector_settings.otel.enabled }}>
                                <label for="otel-enabled"></label>
                            </div>
                            <button class="btn btn-secondary configure-collector" data-collector="otel">Configure</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notifications Tab -->
    <div id="notifications-tab" class="tab-content">
        <div class="card settings-card">
            <div class="card-header">
                <h3 class="card-title">Email Notifications</h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="email-alerts" {{ 'checked' if notification_settings.email_alerts }}>
                        <label class="form-check-label" for="email-alerts">Send alert notifications via email</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="email-reports" {{ 'checked' if notification_settings.email_reports }}>
                        <label class="form-check-label" for="email-reports">Send scheduled reports via email</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="email-system" {{ 'checked' if notification_settings.email_system }}>
                        <label class="form-check-label" for="email-system">Send system notifications via email</label>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card settings-card">
            <div class="card-header">
                <h3 class="card-title">In-App Notifications</h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="app-alerts" {{ 'checked' if notification_settings.app_alerts }}>
                        <label class="form-check-label" for="app-alerts">Show alert notifications in-app</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="app-reports" {{ 'checked' if notification_settings.app_reports }}>
                        <label class="form-check-label" for="app-reports">Show report completion notifications in-app</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="app-system" {{ 'checked' if notification_settings.app_system }}>
                        <label class="form-check-label" for="app-system">Show system notifications in-app</label>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card settings-card">
            <div class="card-header">
                <h3 class="card-title">Desktop Notifications</h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="desktop-alerts" {{ 'checked' if notification_settings.desktop_alerts }}>
                        <label class="form-check-label" for="desktop-alerts">Show alert notifications on desktop</label>
                    </div>
                </div>
                
                <button id="enable-notifications" class="btn btn-secondary mt-3" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                    </svg>
                    Enable Browser Notifications
                </button>
                
                <button id="save-notification-settings" class="btn btn-primary mt-4">Save Notification Settings</button>
            </div>
        </div>
    </div>
    
    <!-- Security Tab -->
    <div id="security-tab" class="tab-content">
        <div class="card settings-card">
            <div class="card-header">
                <h3 class="card-title">Change Password</h3>
            </div>
            <div class="card-body">
                <form id="password-form">
                    <div class="form-group">
                        <label for="current-password" class="form-label">Current Password</label>
                        <input type="password" id="current-password" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="new-password" class="form-label">New Password</label>
                        <input type="password" id="new-password" class="form-control" required>
                        
                        <div class="password-strength">
                            <div class="password-strength-bar"></div>
                        </div>
                        <div class="strength-text"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirm-password" class="form-label">Confirm New Password</label>
                        <input type="password" id="confirm-password" class="form-control" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Update Password</button>
                </form>
            </div>
        </div>
        
        <div class="card settings-card">
            <div class="card-header">
                <h3 class="card-title">Two-Factor Authentication</h3>
            </div>
            <div class="card-body">
                {% if not current_user.two_factor_enabled %}
                <p>Two-factor authentication is not enabled. Enable it to add an extra layer of security to your account.</p>
                <button id="enable-2fa" class="btn btn-primary">Enable Two-Factor Authentication</button>
                {% else %}
                <p>Two-factor authentication is currently enabled.</p>
                <button id="disable-2fa" class="btn btn-danger">Disable Two-Factor Authentication</button>
                {% endif %}
            </div>
        </div>
        
        <div class="card settings-card">
            <div class="card-header">
                <h3 class="card-title">Login Sessions</h3>
            </div>
            <div class="card-body">
                <p>These are your active login sessions.</p>
                
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Device</th>
                                <th>Location</th>
                                <th>IP Address</th>
                                <th>Last Active</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for session in active_sessions %}
                            <tr>
                                <td>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                                        <line x1="8" y1="21" x2="16" y2="21"></line>
                                        <line x1="12" y1="17" x2="12" y2="21"></line>
                                    </svg>
                                    {{ session.device }}
                                    {% if session.current %}
                                    <span class="badge badge-info">Current</span>
                                    {% endif %}
                                </td>
                                <td>{{ session.location }}</td>
                                <td>{{ session.ip_address }}</td>
                                <td>{{ session.last_active|format_datetime }}</td>
                                <td>
                                    {% if not session.current %}
                                    <button class="btn btn-sm btn-danger terminate-session" data-session-id="{{ session.id }}">Terminate</button>
                                    {% else %}
                                    <span class="text-muted">Current Session</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <button id="terminate-all-sessions" class="btn btn-danger mt-3">Terminate All Other Sessions</button>
            </div>
        </div>
    </div>
    
    <!-- Data Management Tab -->
    <div id="data-tab" class="tab-content">
        <div class="card settings-card">
            <div class="card-header">
                <h3 class="card-title">Data Retention</h3>
            </div>
            <div class="card-body">
                <p class="text-muted">Configure how long different types of data are stored in the system.</p>
                
                <div class="form-group">
                    <label for="logs-retention" class="form-label">Log Retention</label>
                    <div class="d-flex align-items-center">
                        <input type="range" id="logs-retention" class="data-retention-slider form-control" min="1" max="365" step="1" value="{{ data_retention.logs }}">
                        <span class="ml-3" id="logs-retention-display">{{ data_retention.logs }} days</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="metrics-retention" class="form-label">Metrics Retention</label>
                    <div class="d-flex align-items-center">
                        <input type="range" id="metrics-retention" class="data-retention-slider form-control" min="1" max="365" step="1" value="{{ data_retention.metrics }}">
                        <span class="ml-3" id="metrics-retention-display">{{ data_retention.metrics }} days</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="alerts-retention" class="form-label">Alerts Retention</label>
                    <div class="d-flex align-items-center">
                        <input type="range" id="alerts-retention" class="data-retention-slider form-control" min="1" max="365" step="1" value="{{ data_retention.alerts }}">
                        <span class="ml-3" id="alerts-retention-display">{{ data_retention.alerts }} days</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="reports-retention" class="form-label">Reports Retention</label>
                    <div class="d-flex align-items-center">
                        <input type="range" id="reports-retention" class="data-retention-slider form-control" min="1" max="365" step="1" value="{{ data_retention.reports }}">
                        <span class="ml-3" id="reports-retention-display">{{ data_retention.reports }} days</span>
                    </div>
                </div>
                
                <button id="save-retention-settings" class="btn btn-primary">Save Retention Settings</button>
            </div>
        </div>
        
        <div class="card settings-card">
            <div class="card-header">
                <h3 class="card-title">Data Export</h3>
            </div>
            <div class="card-body">
                <p>Export your data for backup or migration purposes.</p>
                
                <div class="form-group">
                    <label class="form-label">Export Options</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="export-dashboards" checked>
                        <label class="form-check-label" for="export-dashboards">Dashboards</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="export-reports" checked>
                        <label class="form-check-label" for="export-reports">Reports</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="export-alerts" checked>
                        <label class="form-check-label" for="export-alerts">Alert Rules</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="export-settings" checked>
                        <label class="form-check-label" for="export-settings">Settings</label>
                    </div>
                </div>
                
                <button id="export-data" class="btn btn-primary">Export Data</button>
            </div>
        </div>
        
        <div class="card settings-card">
            <div class="card-header">
                <h3 class="card-title">Data Cleanup</h3>
                <span class="badge badge-warning">Caution</span>
            </div>
            <div class="card-body">
                <p class="text-warning">The following actions will permanently delete data and cannot be undone.</p>
                
                <div class="form-group">
                    <button id="clear-logs" class="btn btn-danger">Clear All Logs</button>
                    <button id="clear-metrics" class="btn btn-danger ml-2">Clear All Metrics</button>
                    <button id="clear-alerts" class="btn btn-danger ml-2">Clear Alert History</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- API Access Tab -->
    <div id="api-tab" class="tab-content">
        <div class="card settings-card">
            <div class="card-header">
                <h3 class="card-title">API Tokens</h3>
            </div>
            <div class="card-body">
                <p>Create and manage API tokens for programmatic access to the platform.</p>
                
                <div class="form-group">
                    <label for="token-name" class="form-label">Token Name</label>
                    <input type="text" id="token-name" class="form-control" placeholder="e.g., Integration Token">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Token Permissions</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="perm-read" checked>
                        <label class="form-check-label" for="perm-read">Read (GET)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="perm-write">
                        <label class="form-check-label" for="perm-write">Write (POST, PUT)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="perm-delete">
                        <label class="form-check-label" for="perm-delete">Delete</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="token-expiry" class="form-label">Expiration</label>
                    <select id="token-expiry" class="form-control">
                        <option value="never">Never</option>
                        <option value="30" selected>30 days</option>
                        <option value="60">60 days</option>
                        <option value="90">90 days</option>
                        <option value="180">180 days</option>
                        <option value="365">1 year</option>
                    </select>
                </div>
                
                <button id="generate-token" class="btn btn-primary">Generate API Token</button>
                
                <!-- New token display (initially hidden) -->
                <div id="new-token-container" class="mt-3" style="display: none;">
                    <div class="alert alert-info">
                        <p>Your new API token has been generated. Make sure to copy it now; it won't be shown again.</p>
                        <div class="api-token" id="new-token-value">
                            <span id="token-text">API_TOKEN_WILL_APPEAR_HERE</span>
                            <button class="copy-token" id="copy-token" title="Copy to clipboard">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <h4 class="mt-4">Your API Tokens</h4>
                
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Created</th>
                                <th>Expires</th>
                                <th>Last Used</th>
                                <th>Permissions</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if api_tokens %}
                                {% for token in api_tokens %}
                                <tr>
                                    <td>{{ token.name }}</td>
                                    <td>{{ token.created_at|format_datetime }}</td>
                                    <td>
                                        {% if token.expires_at %}
                                        {{ token.expires_at|format_datetime }}
                                        {% else %}
                                        Never
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if token.last_used_at %}
                                        {{ token.last_used_at|format_datetime }}
                                        {% else %}
                                        Never
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if token.permissions.read %}
                                        <span class="badge badge-info">Read</span>
                                        {% endif %}
                                        {% if token.permissions.write %}
                                        <span class="badge badge-warning">Write</span>
                                        {% endif %}
                                        {% if token.permissions.delete %}
                                        <span class="badge badge-error">Delete</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-danger revoke-token" data-token-id="{{ token.id }}">Revoke</button>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="6" class="text-center">No API tokens created yet</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="card settings-card">
            <div class="card-header">
                <h3 class="card-title">API Documentation</h3>
            </div>
            <div class="card-body">
                <p>Access API documentation and examples for integrating with the platform.</p>
                
                <div class="d-flex">
                    <a href="/api/docs" target="_blank" class="btn btn-primary">View API Documentation</a>
                    <a href="/api/examples" target="_blank" class="btn btn-secondary ml-2">Download Examples</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                
                // Update active tab
                document.querySelectorAll('.tab').forEach(t => {
                    t.classList.remove('active');
                });
                this.classList.add('active');
                
                // Show corresponding content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabId}-tab`).classList.add('active');
            });
        });
        
        // Avatar upload functionality
        const avatarEdit = document.querySelector('.avatar-edit');
        const avatarUpload = document.getElementById('avatar-upload');
        
        if (avatarEdit && avatarUpload) {
            avatarEdit.addEventListener('click', function() {
                avatarUpload.click();
            });
            
            avatarUpload.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    
                    // Check file type and size
                    if (!file.type.match('image.*')) {
                        showNotification('Please select an image file', 'error');
                        return;
                    }
                    
                    if (file.size > 2 * 1024 * 1024) {
                        showNotification('Image size should be less than 2MB', 'error');
                        return;
                    }
                    
                    // Preview the image
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const avatarPreview = document.querySelector('.avatar-preview');
                        avatarPreview.innerHTML = `<img src="${e.target.result}" alt="Profile avatar">`;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        // Password strength functionality
        const newPassword = document.getElementById('new-password');
        const confirmPassword = document.getElementById('confirm-password');
        const strengthBar = document.querySelector('.password-strength-bar');
        const strengthText = document.querySelector('.strength-text');
        
        if (newPassword && strengthBar && strengthText) {
            newPassword.addEventListener('input', function() {
                const password = this.value;
                let strength = 0;
                let feedback = '';
                
                if (password.length >= 8) strength += 1;
                if (password.match(/[A-Z]/)) strength += 1;
                if (password.match(/[0-9]/)) strength += 1;
                if (password.match(/[^A-Za-z0-9]/)) strength += 1;
                
                // Update strength indicator
                if (password.length === 0) {
                    strengthBar.style.width = '0';
                    strengthText.textContent = '';
                    document.querySelector('.password-strength').className = 'password-strength';
                } else if (strength <= 2) {
                    document.querySelector('.password-strength').className = 'password-strength strength-weak';
                    strengthText.textContent = 'Weak';
                    strengthText.style.color = 'var(--error-color)';
                } else if (strength === 3) {
                    document.querySelector('.password-strength').className = 'password-strength strength-medium';
                    strengthText.textContent = 'Medium';
                    strengthText.style.color = 'var(--warning-color)';
                } else {
                    document.querySelector('.password-strength').className = 'password-strength strength-strong';
                    strengthText.textContent = 'Strong';
                    strengthText.style.color = 'var(--success-color)';
                }
            });
            
            if (confirmPassword) {
                confirmPassword.addEventListener('input', function() {
                    if (this.value === newPassword.value) {
                        this.setCustomValidity('');
                    } else {
                        this.setCustomValidity('Passwords do not match');
                    }
                });
            }
        }
        
        // Theme selector functionality
        const themeOptions = document.querySelectorAll('.theme-option');
        
        themeOptions.forEach(option => {
            option.addEventListener('click', function() {
                const theme = this.getAttribute('data-theme');
                
                // Update active class
                themeOptions.forEach(opt => {
                    opt.classList.remove('active');
                });
                this.classList.add('active');
                
                // Apply theme
                if (window.themeManager) {
                    window.themeManager.applyTheme(theme);
                }
            });
        });
        
        // Data retention sliders
        const retentionSliders = document.querySelectorAll('.data-retention-slider');
        
        retentionSliders.forEach(slider => {
            const display = document.getElementById(`${slider.id}-display`);
            
            slider.addEventListener('input', function() {
                display.textContent = `${this.value} days`;
            });
        });
        
        // API token generation
        const generateTokenBtn = document.getElementById('generate-token');
        
        if (generateTokenBtn) {
            generateTokenBtn.addEventListener('click', function() {
                const tokenName = document.getElementById('token-name').value;
                
                if (!tokenName) {
                    showNotification('Please enter a token name', 'warning');
                    return;
                }
                
                // Collect permissions
                const permissions = {
                    read: document.getElementById('perm-read').checked,
                    write: document.getElementById('perm-write').checked,
                    delete: document.getElementById('perm-delete').checked
                };
                
                // Get expiry
                const expiry = document.getElementById('token-expiry').value;
                
                // Send API request
                fetch('/api/tokens', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: tokenName,
                        permissions: permissions,
                        expiry: expiry
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to generate token');
                    }
                    return response.json();
                })
                .then(data => {
                    // Display the token
                    document.getElementById('new-token-container').style.display = 'block';
                    document.getElementById('token-text').textContent = data.token;
                    
                    // Refresh the table
                    setTimeout(() => {
                        location.reload();
                    }, 5000);
                })
                .catch(error => {
                    console.error('Error generating token:', error);
                    showNotification('Error generating token', 'error');
                });
            });
        }
        
        // Copy token button
        const copyTokenBtn = document.getElementById('copy-token');
        
        if (copyTokenBtn) {
            copyTokenBtn.addEventListener('click', function() {
                const tokenText = document.getElementById('token-text').textContent;
                
                navigator.clipboard.writeText(tokenText)
                    .then(() => {
                        showNotification('Token copied to clipboard', 'success');
                    })
                    .catch(() => {
                        showNotification('Failed to copy token', 'error');
                    });
            });
        }
        
        // Profile form submission
        const profileForm = document.getElementById('profile-form');
        
        if (profileForm) {
            profileForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const userData = {
                    username: document.getElementById('username').value,
                    email: document.getElementById('email').value,
                    full_name: document.getElementById('full-name').value,
                    job_title: document.getElementById('job-title').value,
                    timezone: document.getElementById('timezone').value
                };
                
                // Send to server
                fetch('/api/users/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to update profile');
                    }
                    return response.json();
                })
                .then(data => {
                    showNotification('Profile updated successfully', 'success');
                })
                .catch(error => {
                    console.error('Error updating profile:', error);
                    showNotification('Error updating profile', 'error');
                });
            });
        }
        
        // Password form submission
        const passwordForm = document.getElementById('password-form');
        
        if (passwordForm) {
            passwordForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                
                if (newPassword !== confirmPassword) {
                    showNotification('Passwords do not match', 'error');
                    return;
                }
                
                // Send to server
                fetch('/api/users/password', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to update password');
                    }
                    return response.json();
                })
                .then(data => {
                    showNotification('Password updated successfully', 'success');
                    passwordForm.reset();
                    document.querySelector('.password-strength').className = 'password-strength';
                    document.querySelector('.password-strength-bar').style.width = '0';
                    document.querySelector('.strength-text').textContent = '';
                })
                .catch(error => {
                    console.error('Error updating password:', error);
                    showNotification('Error updating password', 'error');
                });
            });
        }
        
        // Helper function to show notifications
        function showNotification(message, type) {
            // Check if notification container exists
            let container = document.querySelector('.notification-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'notification-container';
                container.style.position = 'fixed';
                container.style.top = '20px';
                container.style.right = '20px';
                container.style.zIndex = '9999';
                document.body.appendChild(container);
            }
            
            // Create notification
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} fade-in`;
            notification.innerHTML = `
                ${message}
                <button class="close-alert">&times;</button>
            `;
            
            // Add notification to container
            container.appendChild(notification);
            
            // Add close button event listener
            notification.querySelector('.close-alert').addEventListener('click', () => {
                notification.remove();
            });
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }
    });
</script>
{% endblock %}
